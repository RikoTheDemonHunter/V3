repeat task.wait() until game:IsLoaded()

local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local TweenService = game:GetService("TweenService")
local UserInputService = game:GetService("UserInputService")
local player = Players.LocalPlayer

local safeZoneFolder
local running = false
local safeZoneParts = {}
local shieldPart
local safeZoneCenter = Vector3.new(0,3600,0)
local safeZoneHalfExtents = Vector3.new(300,50,300)
local hueValue = 0
local colorSpeedMultiplier = 1
local baseSaturation = 0.7
local healEnabled = false
local shieldEnabled = true
local autoTeleportEnabled = false
local healRate = 5

-- RGB Effect
local function RGBEffect(label)
	if not label then return end
	task.spawn(function()
		while label and label.Parent do
			for h = 0,1,0.01 do
				if not (label and label.Parent) then break end
				label.TextColor3 = Color3.fromHSV(h,1,1)
				task.wait(0.05)
			end
		end
	end)
end

-- Update SafeZone Parts Color
local function updatePartsColor(delta)
	hueValue = (hueValue + delta * 0.1 * colorSpeedMultiplier) % 1
	local color = Color3.fromHSV(hueValue, baseSaturation, 1)
	for _, part in pairs(safeZoneParts) do
		if part and part.Parent then
			pcall(function() part.Color = color end)
		end
	end
end

local function insideSafeZone(pos)
	if not safeZoneFolder then return false end
	local min = safeZoneCenter - safeZoneHalfExtents
	local max = safeZoneCenter + safeZoneHalfExtents
	return pos.X >= min.X and pos.X <= max.X
	   and pos.Y >= min.Y and pos.Y <= max.Y
	   and pos.Z >= min.Z and pos.Z <= max.Z
end

-- Shield
local function createShield(wSize, duration)
	if shieldPart and shieldPart.Parent then shieldPart:Destroy() end
	shieldPart = Instance.new("Part")
	shieldPart.Shape = Enum.PartType.Ball
	shieldPart.Size = Vector3.new(1,1,1)
	shieldPart.Position = safeZoneCenter
	shieldPart.Anchored = true
	shieldPart.CanCollide = false
	shieldPart.Transparency = 0.6
	shieldPart.Material = Enum.Material.Glass
	shieldPart.Color = Color3.fromRGB(170,170,255)
	shieldPart.Parent = workspace
	local targetSize = Vector3.new(wSize*1.2, wSize*1.2, wSize*1.2)
	local tweenInfo = TweenInfo.new(math.max(0.6, duration), Enum.EasingStyle.Quad, Enum.EasingDirection.Out)
	local tw = TweenService:Create(shieldPart, tweenInfo, {Size = targetSize, Transparency = 0.85})
	tw:Play()
	delay(duration + 0.35, function()
		if shieldPart and shieldPart.Parent then
			shieldPart:Destroy()
			shieldPart = nil
		end
	end)
end

-- Create SafeZone
local function createSafeZone()
	if safeZoneFolder then return end
	safeZoneFolder = Instance.new("Folder")
	safeZoneFolder.Name = "SafeZone"
	safeZoneFolder.Parent = workspace

	local cubeSize = 600
	local cubeHeight = 100
	local yPos = 3600
	local entranceWidth = 100
	local pathWidth = 100
	local pathLength = 300
	local baseplateWidth = 800
	local baseplateDepth = 600

	safeZoneCenter = Vector3.new(0, yPos, 0)
	safeZoneHalfExtents = Vector3.new(cubeSize/2, cubeHeight/2, cubeSize/2)

	local floor = Instance.new("Part")
	floor.Size = Vector3.new(cubeSize,10,cubeSize)
	floor.Position = Vector3.new(0, yPos+5,0)
	floor.Anchored = true
	floor.Material = Enum.Material.SmoothPlastic
	floor.Transparency = 0.5
	floor.Reflectance = 0.2
	floor.Color = Color3.fromRGB(0,0,255)
	floor.Parent = safeZoneFolder
	table.insert(safeZoneParts, floor)

	local function createWall(pos, size)
		local wall = Instance.new("Part")
		wall.Size = size
		wall.Position = pos
		wall.Anchored = true
		wall.Material = Enum.Material.SmoothPlastic
		wall.Transparency = 0.4
		wall.Color = Color3.fromRGB(0,0,255)
		wall.Parent = safeZoneFolder
		table.insert(safeZoneParts, wall)
	end

	createWall(Vector3.new(-cubeSize/2,yPos+cubeHeight/2,0), Vector3.new(20,cubeHeight,cubeSize))
	createWall(Vector3.new(cubeSize/2,yPos+cubeHeight/2,0), Vector3.new(20,cubeHeight,cubeSize))
	createWall(Vector3.new(0,yPos+cubeHeight/2,cubeSize/2), Vector3.new(cubeSize,cubeHeight,20))

	local frontLeft = Instance.new("Part")
	frontLeft.Size = Vector3.new((cubeSize-entranceWidth)/2,cubeHeight,20)
	frontLeft.Position = Vector3.new(-(cubeSize-entranceWidth)/4 - entranceWidth/2, yPos+cubeHeight/2, -cubeSize/2)
	frontLeft.Anchored = true
	frontLeft.Material = Enum.Material.SmoothPlastic
	frontLeft.Transparency = 0.4
	frontLeft.Color = Color3.fromRGB(0,0,255)
	frontLeft.Parent = safeZoneFolder
	table.insert(safeZoneParts, frontLeft)

	local frontRight = Instance.new("Part")
	frontRight.Size = Vector3.new((cubeSize-entranceWidth)/2,cubeHeight,20)
	frontRight.Position = Vector3.new((cubeSize-entranceWidth)/4 + entranceWidth/2, yPos+cubeHeight/2, -cubeSize/2)
	frontRight.Anchored = true
	frontRight.Material = Enum.Material.SmoothPlastic
	frontRight.Transparency = 0.4
	frontRight.Color = Color3.fromRGB(0,0,255)
	frontRight.Parent = safeZoneFolder
	table.insert(safeZoneParts, frontRight)

	local path = Instance.new("Part")
	path.Size = Vector3.new(pathWidth,10,pathLength)
	path.Position = Vector3.new(0, yPos+5, -cubeSize/2 - pathLength/2)
	path.Anchored = true
	path.Material = Enum.Material.Concrete
	path.Color = Color3.fromRGB(128,128,128)
	path.Parent = safeZoneFolder

	local baseplate = Instance.new("Part")
	baseplate.Size = Vector3.new(baseplateWidth,10,baseplateDepth)
	baseplate.Position = Vector3.new(0, yPos-5, -cubeSize/2 - pathLength - baseplateDepth/2)
	baseplate.Anchored = true
	baseplate.Material = Enum.Material.Grass
	baseplate.Color = Color3.fromRGB(0,255,0)
	baseplate.Parent = safeZoneFolder

	local signPart = Instance.new("Part")
	signPart.Size = Vector3.new(200,50,5)
	signPart.Position = Vector3.new(0, yPos+60, -cubeSize/2 - pathLength - baseplateDepth/2)
	signPart.Anchored = true
	signPart.Material = Enum.Material.SmoothPlastic
	signPart.Color = Color3.fromRGB(255,0,255)
	signPart.Transparency = 0.7
	signPart.Parent = safeZoneFolder

	local billboard = Instance.new("BillboardGui")
	billboard.Size = UDim2.new(0,200,0,50)
	billboard.AlwaysOnTop = true
	billboard.Adornee = signPart
	billboard.Parent = signPart

	local label = Instance.new("TextLabel")
	label.Size = UDim2.new(1,0,1,0)
	label.BackgroundTransparency = 1
	label.Text = "Made by Avery"
	label.TextScaled = true
	label.Font = Enum.Font.GothamBold
	label.TextTransparency = 0
	label.Parent = billboard

	RGBEffect(label)

	if shieldEnabled then
		createShield(600,0.8)
	end
end

local function removeSafeZone()
	if safeZoneFolder and safeZoneFolder.Parent then
		safeZoneFolder:Destroy()
		safeZoneFolder = nil
		safeZoneParts = {}
	end
	if shieldPart and shieldPart.Parent then
		shieldPart:Destroy()
		shieldPart = nil
	end
end

-- Smooth corrective teleport
local function smoothTeleport(targetPos, duration)
	local char = player.Character
	if char then
		local root = char:FindFirstChild("HumanoidRootPart")
		if root then
			local tweenInfo = TweenInfo.new(duration or 0.6, Enum.EasingStyle.Quad, Enum.EasingDirection.Out)
			local goal = {CFrame = CFrame.new(targetPos + Vector3.new(0,10,0))}
			TweenService:Create(root, tweenInfo, goal):Play()
		end
	end
end

-- GUI Setup
local screenGui = Instance.new("ScreenGui")
screenGui.Name = "SafeZoneGui"
screenGui.Parent = player:WaitForChild("PlayerGui")

local mainFrame = Instance.new("Frame")
mainFrame.Size = UDim2.new(0, 260, 0, 360)
mainFrame.Position = UDim2.new(0.05,0,0.2,0)
mainFrame.BackgroundColor3 = Color3.fromRGB(40,40,40)
mainFrame.BorderSizePixel = 0
mainFrame.Parent = screenGui

local header = Instance.new("Frame")
header.Size = UDim2.new(1,0,0,30)
header.BackgroundColor3 = Color3.fromRGB(30,30,30)
header.Parent = mainFrame

local title = Instance.new("TextLabel")
title.Size = UDim2.new(1,-60,1,0)
title.BackgroundTransparency = 1
title.Text = "SafeZone Panel"
title.TextColor3 = Color3.fromRGB(255,255,255)
title.Font = Enum.Font.SourceSansBold
title.TextSize = 18
title.Parent = header

local minimizeButton = Instance.new("TextButton")
minimizeButton.Size = UDim2.new(0,30,0,30)
minimizeButton.Position = UDim2.new(1,-60,0,0)
minimizeButton.Text = "_"
minimizeButton.TextColor3 = Color3.fromRGB(255,255,255)
minimizeButton.BackgroundColor3 = Color3.fromRGB(60,60,60)
minimizeButton.Parent = header

local closeButton = Instance.new("TextButton")
closeButton.Size = UDim2.new(0,30,0,30)
closeButton.Position = UDim2.new(1,-30,0,0)
closeButton.Text = "X"
closeButton.TextColor3 = Color3.fromRGB(255,255,255)
closeButton.BackgroundColor3 = Color3.fromRGB(60,60,60)
closeButton.Parent = header

-- Draggable
local dragging, dragInput, dragStart, startPos = false,nil,nil,nil
header.InputBegan:Connect(function(input)
	if input.UserInputType == Enum.UserInputType.MouseButton1 then
		dragging = true
		dragStart = input.Position
		startPos = mainFrame.Position
		input.Changed:Connect(function()
			if input.UserInputState == Enum.UserInputState.End then
				dragging = false
			end
		end)
	end
end)
header.InputChanged:Connect(function(input)
	if input.UserInputType == Enum.UserInputType.MouseMovement then
		dragInput = input
	end
end)
UserInputService.InputChanged:Connect(function(input)
	if input == dragInput and dragging then
		local delta = input.Position - dragStart
		mainFrame.Position = UDim2.new(startPos.X.Scale, startPos.X.Offset + delta.X,
										startPos.Y.Scale, startPos.Y.Offset + delta.Y)
	end
end)

minimizeButton.MouseButton1Click:Connect(function()
	if mainFrame.Size.Y.Offset > 40 then
		mainFrame.Size = UDim2.new(mainFrame.Size.X.Scale, mainFrame.Size.X.Offset, 0, 30)
	else
		mainFrame.Size = UDim2.new(0,260,0,360)
	end
end)

closeButton.MouseButton1Click:Connect(function()
	mainFrame.Visible = false
end)

local toggleGUIButton = Instance.new("TextButton")
toggleGUIButton.Size = UDim2.new(0,100,0,40)
toggleGUIButton.Position = UDim2.new(0.01,0,0.85,0)
toggleGUIButton.Text = "Show GUI"
toggleGUIButton.BackgroundColor3 = Color3.fromRGB(60,60,60)
toggleGUIButton.TextColor3 = Color3.fromRGB(255,255,255)
toggleGUIButton.Font = Enum.Font.SourceSansBold
toggleGUIButton.TextSize = 16
toggleGUIButton.Parent = screenGui

toggleGUIButton.MouseButton1Click:Connect(function()
	mainFrame.Visible = not mainFrame.Visible
	toggleGUIButton.Text = mainFrame.Visible and "Hide GUI" or "Show GUI"
end)

-- Feature Buttons
local function createToggleBtn(parent, y, text, var)
	local btn = Instance.new("TextButton")
	btn.Size = UDim2.new(0,200,0,30)
	btn.Position = UDim2.new(0,30,0,y)
	btn.BackgroundColor3 = Color3.fromRGB(60,60,60)
	btn.TextColor3 = Color3.fromRGB(255,255,255)
	btn.Font = Enum.Font.SourceSansBold
	btn.TextSize = 18
	btn.Parent = parent
	btn.Text = text.." : "..(var[1] and "ON" or "OFF")
	btn.MouseButton1Click:Connect(function()
		var[1] = not var[1]
		btn.Text = text.." : "..(var[1] and "ON" or "OFF")
	end)
	return btn
end

local safeZoneVar = {running}
local healVar = {healEnabled}
local shieldVar = {shieldEnabled}
local autoTPVar = {autoTeleportEnabled}

createToggleBtn(mainFrame,50,"SafeZone",safeZoneVar)
createToggleBtn(mainFrame,90,"Heal",healVar)
createToggleBtn(mainFrame,130,"Shield",shieldVar)
createToggleBtn(mainFrame,170,"Auto-Teleport",autoTPVar)

local sliderLabel = Instance.new("TextLabel")
sliderLabel.Size = UDim2.new(0,200,0,20)
sliderLabel.Position = UDim2.new(0,30,0,220)
sliderLabel.BackgroundTransparency = 1
sliderLabel.TextColor3 = Color3.fromRGB(255,255,255)
sliderLabel.Font = Enum.Font.SourceSansBold
sliderLabel.TextSize = 16
sliderLabel.Text = "RGB Speed: "..colorSpeedMultiplier
sliderLabel.Parent = mainFrame

local slider = Instance.new("TextBox")
slider.Size = UDim2.new(0,200,0,30)
slider.Position = UDim2.new(0,30,0,245)
slider.BackgroundColor3 = Color3.fromRGB(70,70,70)
slider.TextColor3 = Color3.fromRGB(255,255,255)
slider.Font = Enum.Font.SourceSansBold
slider.TextSize = 18
slider.Text = tostring(colorSpeedMultiplier)
slider.Parent = mainFrame

slider.FocusLost:Connect(function()
	local num = tonumber(slider.Text)
	if num and num > 0 then
		colorSpeedMultiplier = num
		sliderLabel.Text = "RGB Speed: "..num
		slider.Text = tostring(num)
	else
		slider.Text = tostring(colorSpeedMultiplier)
	end
end)

-- Heartbeat logic
RunService.Heartbeat:Connect(function()
	running = safeZoneVar[1]
	healEnabled = healVar[1]
	shieldEnabled = shieldVar[1]
	autoTeleportEnabled = autoTPVar[1]

	if running and not safeZoneFolder then
		createSafeZone()
	elseif not running and safeZoneFolder then
		removeSafeZone()
	end

	if healEnabled and player.Character and player.Character:FindFirstChild("Humanoid") then
		player.Character.Humanoid.Health = math.min(player.Character.Humanoid.MaxHealth, player.Character.Humanoid.Health + healRate * RunService.Heartbeat:Wait())
	end
end)

RunService.RenderStepped:Connect(function(dt)
	if running then
		updatePartsColor(dt)
	end
end)

-- Smooth corrective auto-teleport
RunService.Heartbeat:Connect(function()
	if running and autoTeleportEnabled then
		local root = player.Character and player.Character:FindFirstChild("HumanoidRootPart")
		local hum = player.Character and player.Character:FindFirstChild("Humanoid")
		if root and hum and hum.Health > 0 and not insideSafeZone(root.Position) then
			smoothTeleport(safeZoneCenter,0.6)
		end
	end
end)
